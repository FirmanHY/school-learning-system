<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - School Learning System</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">School Dashboard</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
          aria-controls="navbarNav"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link" href="#profile">Profile</a>
            </li>
            <li class="nav-item" id="adminUsersLink" style="display: none">
              <a class="nav-link" href="#users">Users</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#materials">Materials</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#tasks">Tasks</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#grades">Grades</a>
            </li>
          </ul>
          <button class="btn btn-outline-danger ms-auto" onclick="logout()">
            Logout
          </button>
        </div>
      </div>
    </nav>

    <div class="container mt-4">
      <!-- Profile Section -->
      <section id="profile">
        <h2>Profile</h2>
        <p>Username: <span id="username"></span></p>
        <p>Role: <span id="role"></span></p>
        <p>Email: <span id="email"></span></p>
      </section>

      <!-- Users Section (Admin only) -->
      <section id="users" style="display: none">
        <h2>Users</h2>
        <table class="table table-striped">
          <thead>
            <tr>
              <th>ID</th>
              <th>Username</th>
              <th>Role</th>
              <th>Class ID</th>
            </tr>
          </thead>
          <tbody id="usersTable"></tbody>
        </table>
      </section>

      <!-- Materials Section -->
      <section id="materials">
        <h2>Materials</h2>
        <button
          id="createMaterialBtn"
          class="btn btn-primary mb-3"
          data-bs-toggle="modal"
          data-bs-target="#materialModal"
          style="display: none"
        >
          Create Material
        </button>
        <table class="table table-striped">
          <thead>
            <tr>
              <th>ID</th>
              <th>Title</th>
              <th>Content</th>
              <th>Subject ID</th>
              <th>Class ID</th>
              <th>Owner ID</th>
              <th>Privacy</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="materialsTable"></tbody>
        </table>
      </section>

      <!-- Tasks Section -->
      <section id="tasks">
        <h2>Tasks</h2>
        <button
          id="createTaskBtn"
          class="btn btn-primary mb-3"
          data-bs-toggle="modal"
          data-bs-target="#taskModal"
          style="display: none"
        >
          Create Task
        </button>
        <table class="table table-striped">
          <thead>
            <tr>
              <th>ID</th>
              <th>Title</th>
              <th>Description</th>
              <th>Subject ID</th>
              <th>Class ID</th>
              <th>Owner ID</th>
              <th>Due Date</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="tasksTable"></tbody>
        </table>
      </section>

      <!-- Grades Section -->
      <section id="grades">
        <h2>Grades</h2>
        <table class="table table-striped">
          <thead>
            <tr>
              <th>ID</th>
              <th>Student ID</th>
              <th>Subject ID</th>
              <th>Value</th>
              <th>Status</th>
              <th>Privacy</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="gradesTable"></tbody>
        </table>
      </section>
    </div>

    <!-- Material Modal -->
    <div
      class="modal fade"
      id="materialModal"
      tabindex="-1"
      aria-labelledby="materialModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="materialModalLabel">Material</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="materialForm">
              <input type="hidden" id="materialId" />
              <div class="mb-3">
                <label for="materialTitle" class="form-label">Title</label>
                <input
                  type="text"
                  class="form-control"
                  id="materialTitle"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="materialContent" class="form-label">Content</label>
                <textarea
                  class="form-control"
                  id="materialContent"
                  required
                ></textarea>
              </div>
              <div class="mb-3">
                <label for="materialSubjectId" class="form-label"
                  >Subject ID</label
                >
                <input
                  type="number"
                  class="form-control"
                  id="materialSubjectId"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="materialClassId" class="form-label">Class ID</label>
                <input
                  type="number"
                  class="form-control"
                  id="materialClassId"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="materialPrivacy" class="form-label"
                  >Privacy Level</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="materialPrivacy"
                  required
                />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
            <button type="button" class="btn btn-primary" id="saveMaterial">
              Save
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Task Modal -->
    <div
      class="modal fade"
      id="taskModal"
      tabindex="-1"
      aria-labelledby="taskModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="taskModalLabel">Task</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="taskForm">
              <input type="hidden" id="taskId" />
              <div class="mb-3">
                <label for="taskTitle" class="form-label">Title</label>
                <input
                  type="text"
                  class="form-control"
                  id="taskTitle"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="taskDescription" class="form-label"
                  >Description</label
                >
                <textarea
                  class="form-control"
                  id="taskDescription"
                  required
                ></textarea>
              </div>
              <div class="mb-3">
                <label for="taskSubjectId" class="form-label">Subject ID</label>
                <input
                  type="number"
                  class="form-control"
                  id="taskSubjectId"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="taskClassId" class="form-label">Class ID</label>
                <input
                  type="number"
                  class="form-control"
                  id="taskClassId"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="taskDueDate" class="form-label">Due Date</label>
                <input
                  type="date"
                  class="form-control"
                  id="taskDueDate"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="taskStatus" class="form-label">Status</label>
                <input
                  type="text"
                  class="form-control"
                  id="taskStatus"
                  required
                />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
            <button type="button" class="btn btn-primary" id="saveTask">
              Save
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Submission Modal -->
    <div
      class="modal fade"
      id="submissionModal"
      tabindex="-1"
      aria-labelledby="submissionModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="submissionModalLabel">Submit Task</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="submissionForm">
              <input type="hidden" id="submissionTaskId" />
              <div class="mb-3">
                <label for="submissionContent" class="form-label"
                  >Content</label
                >
                <textarea
                  class="form-control"
                  id="submissionContent"
                  required
                ></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
            <button type="button" class="btn btn-primary" id="saveSubmission">
              Submit
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Grade Modal -->
    <div
      class="modal fade"
      id="gradeModal"
      tabindex="-1"
      aria-labelledby="gradeModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="gradeModalLabel">Update Grade</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="gradeForm">
              <input type="hidden" id="gradeId" />
              <div class="mb-3">
                <label for="gradeValue" class="form-label">Value</label>
                <input
                  type="number"
                  class="form-control"
                  id="gradeValue"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="gradeStatus" class="form-label">Status</label>
                <input
                  type="text"
                  class="form-control"
                  id="gradeStatus"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="gradePrivacy" class="form-label"
                  >Privacy Level</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="gradePrivacy"
                  required
                />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
            <button type="button" class="btn btn-primary" id="saveGrade">
              Save
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      let userRole = "";
      let userClassId = null;

      async function getAccessToken() {
        let token = localStorage.getItem("accessToken");
        if (!token) window.location.href = "login.html";
        try {
          const testRes = await fetch("http://localhost:3000/user/profile", {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (testRes.ok) return token;
        } catch {}
        const refresh = localStorage.getItem("refreshToken");
        if (!refresh) {
          localStorage.clear();
          window.location.href = "login.html";
        }
        const refreshRes = await fetch("http://localhost:3000/auth/refresh", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ refreshToken: refresh }),
        });
        if (!refreshRes.ok) {
          localStorage.clear();
          window.location.href = "login.html";
        }
        const data = await refreshRes.json();
        localStorage.setItem("accessToken", data.accessToken);
        return data.accessToken;
      }

      async function apiCall(endpoint, method = "GET", body = null) {
        const token = await getAccessToken();
        const options = {
          method,
          headers: { Authorization: `Bearer ${token}` },
        };
        if (body) {
          options.headers["Content-Type"] = "application/json";
          options.body = JSON.stringify(body);
        }
        const res = await fetch(`http://localhost:3000${endpoint}`, options);
        if (!res.ok)
          throw new Error(`Error: ${res.status} - ${await res.text()}`);
        return res.json();
      }

      async function logout() {
        const refreshToken = localStorage.getItem("refreshToken");
        try {
          await fetch("http://localhost:3000/auth/logout", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ refreshToken }),
          });
        } catch {}
        localStorage.clear();
        window.location.href = "login.html";
      }

      async function loadProfile() {
        try {
          const user = await apiCall("/user/profile");
          document.getElementById("username").textContent = user.username;
          document.getElementById("role").textContent = user.role;
          document.getElementById("email").textContent = user.email;
          userRole = user.role;
          userClassId = user.class_id;
          if (userRole === "admin") {
            document.getElementById("adminUsersLink").style.display = "block";
            document.getElementById("users").style.display = "block";
            loadUsers();
          }
          if (["admin", "teacher"].includes(userRole)) {
            document.getElementById("createMaterialBtn").style.display =
              "block";
            document.getElementById("createTaskBtn").style.display = "block";
          }
          loadMaterials();
          loadTasks();
          loadGrades();
        } catch (err) {
          alert(err.message);
        }
      }

      async function loadUsers() {
        try {
          const users = await apiCall("/admin/users");
          const table = document.getElementById("usersTable");
          table.innerHTML = "";
          users.forEach((u) => {
            const row = `<tr><td>${u.id}</td><td>${u.username}</td><td>${
              u.role
            }</td><td>${u.class_id || "N/A"}</td></tr>`;
            table.innerHTML += row;
          });
        } catch (err) {
          alert(err.message);
        }
      }

      async function loadMaterials() {
        try {
          const materials = await apiCall("/materials");
          const table = document.getElementById("materialsTable");
          table.innerHTML = "";
          materials.forEach((m) => {
            let actions = "";
            if (["admin", "teacher"].includes(userRole)) {
              actions = `<button class="btn btn-sm btn-warning" onclick="editMaterial(${m.id})">Edit</button>
                                   <button class="btn btn-sm btn-danger" onclick="deleteMaterial(${m.id})">Delete</button>`;
            }
            const row = `<tr><td>${m.id}</td><td>${m.title}</td><td>${m.content}</td><td>${m.subject_id}</td><td>${m.class_id}</td><td>${m.owner_id}</td><td>${m.privacy_level}</td><td>${actions}</td></tr>`;
            table.innerHTML += row;
          });
        } catch (err) {
          alert(err.message);
        }
      }

      function editMaterial(id) {
        apiCall(`/materials/${id}`)
          .then((m) => {
            document.getElementById("materialId").value = m.id;
            document.getElementById("materialTitle").value = m.title;
            document.getElementById("materialContent").value = m.content;
            document.getElementById("materialSubjectId").value = m.subject_id;
            document.getElementById("materialClassId").value = m.class_id;
            document.getElementById("materialPrivacy").value = m.privacy_level;
            new bootstrap.Modal(
              document.getElementById("materialModal")
            ).show();
          })
          .catch(alert);
      }

      async function deleteMaterial(id) {
        if (confirm("Are you sure?")) {
          try {
            await apiCall(`/materials/${id}`, "DELETE");
            loadMaterials();
          } catch (err) {
            alert(err.message);
          }
        }
      }

      document
        .getElementById("saveMaterial")
        .addEventListener("click", async () => {
          const id = document.getElementById("materialId").value;
          const body = {
            title: document.getElementById("materialTitle").value,
            content: document.getElementById("materialContent").value,
            subject_id: parseInt(
              document.getElementById("materialSubjectId").value
            ),
            class_id: parseInt(
              document.getElementById("materialClassId").value
            ),
            privacy_level: document.getElementById("materialPrivacy").value,
          };
          try {
            if (id) {
              await apiCall(`/materials/${id}`, "PUT", body);
            } else {
              await apiCall("/materials", "POST", body);
            }
            loadMaterials();
            bootstrap.Modal.getInstance(
              document.getElementById("materialModal")
            ).hide();
          } catch (err) {
            alert(err.message);
          }
        });

      document
        .getElementById("createMaterialBtn")
        .addEventListener("click", () => {
          document.getElementById("materialForm").reset();
          document.getElementById("materialId").value = "";
        });

      async function loadTasks() {
        try {
          const tasks = await apiCall("/tasks");
          const table = document.getElementById("tasksTable");
          table.innerHTML = "";
          tasks.forEach((t) => {
            let actions = "";
            if (userRole === "student" && t.status === "open") {
              actions += `<button class="btn btn-sm btn-success" onclick="submitTask(${t.id})">Submit</button>`;
            }
            if (["admin", "teacher"].includes(userRole)) {
              actions += `<button class="btn btn-sm btn-warning" onclick="editTask(${t.id})">Edit</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteTask(${t.id})">Delete</button>`;
            }
            const row = `<tr><td>${t.id}</td><td>${t.title}</td><td>${t.description}</td><td>${t.subject_id}</td><td>${t.class_id}</td><td>${t.owner_id}</td><td>${t.due_date}</td><td>${t.status}</td><td>${actions}</td></tr>`;
            table.innerHTML += row;
          });
        } catch (err) {
          alert(err.message);
        }
      }

      function editTask(id) {
        apiCall(`/tasks/${id}`)
          .then((t) => {
            document.getElementById("taskId").value = t.id;
            document.getElementById("taskTitle").value = t.title;
            document.getElementById("taskDescription").value = t.description;
            document.getElementById("taskSubjectId").value = t.subject_id;
            document.getElementById("taskClassId").value = t.class_id;
            document.getElementById("taskDueDate").value = t.due_date;
            document.getElementById("taskStatus").value = t.status;
            new bootstrap.Modal(document.getElementById("taskModal")).show();
          })
          .catch(alert);
      }

      async function deleteTask(id) {
        if (confirm("Are you sure?")) {
          try {
            await apiCall(`/tasks/${id}`, "DELETE");
            loadTasks();
          } catch (err) {
            alert(err.message);
          }
        }
      }

      document
        .getElementById("saveTask")
        .addEventListener("click", async () => {
          const id = document.getElementById("taskId").value;
          const body = {
            title: document.getElementById("taskTitle").value,
            description: document.getElementById("taskDescription").value,
            subject_id: parseInt(
              document.getElementById("taskSubjectId").value
            ),
            class_id: parseInt(document.getElementById("taskClassId").value),
            due_date: document.getElementById("taskDueDate").value,
            status: document.getElementById("taskStatus").value,
          };
          try {
            if (id) {
              await apiCall(`/tasks/${id}`, "PUT", body);
            } else {
              await apiCall("/tasks", "POST", body);
            }
            loadTasks();
            bootstrap.Modal.getInstance(
              document.getElementById("taskModal")
            ).hide();
          } catch (err) {
            alert(err.message);
          }
        });

      document.getElementById("createTaskBtn").addEventListener("click", () => {
        document.getElementById("taskForm").reset();
        document.getElementById("taskId").value = "";
      });

      function submitTask(id) {
        document.getElementById("submissionTaskId").value = id;
        document.getElementById("submissionContent").value = "";
        new bootstrap.Modal(document.getElementById("submissionModal")).show();
      }

      document
        .getElementById("saveSubmission")
        .addEventListener("click", async () => {
          const taskId = document.getElementById("submissionTaskId").value;
          const body = {
            content: document.getElementById("submissionContent").value,
            submitted_at: new Date().toISOString(),
          };
          try {
            await apiCall(`/tasks/${taskId}/submit`, "POST", body);
            loadTasks();
            bootstrap.Modal.getInstance(
              document.getElementById("submissionModal")
            ).hide();
          } catch (err) {
            alert(err.message);
          }
        });

      async function loadGrades() {
        try {
          const grades = await apiCall("/grades");
          const table = document.getElementById("gradesTable");
          table.innerHTML = "";
          grades.forEach((g) => {
            let actions = "";
            if (["admin", "teacher"].includes(userRole)) {
              actions = `<button class="btn btn-sm btn-warning" onclick="editGrade(${g.id})">Edit</button>`;
            }
            const row = `<tr><td>${g.id}</td><td>${g.student_id}</td><td>${g.subject_id}</td><td>${g.value}</td><td>${g.status}</td><td>${g.privacy_level}</td><td>${actions}</td></tr>`;
            table.innerHTML += row;
          });
        } catch (err) {
          alert(err.message);
        }
      }

      function editGrade(id) {
        apiCall(`/grades/${id}`)
          .then((g) => {
            document.getElementById("gradeId").value = g.id;
            document.getElementById("gradeValue").value = g.value;
            document.getElementById("gradeStatus").value = g.status;
            document.getElementById("gradePrivacy").value = g.privacy_level;
            new bootstrap.Modal(document.getElementById("gradeModal")).show();
          })
          .catch(alert);
      }

      document
        .getElementById("saveGrade")
        .addEventListener("click", async () => {
          const id = document.getElementById("gradeId").value;
          const body = {
            value: parseFloat(document.getElementById("gradeValue").value),
            status: document.getElementById("gradeStatus").value,
            privacy_level: document.getElementById("gradePrivacy").value,
          };
          try {
            await apiCall(`/grades/${id}`, "PUT", body);
            loadGrades();
            bootstrap.Modal.getInstance(
              document.getElementById("gradeModal")
            ).hide();
          } catch (err) {
            alert(err.message);
          }
        });

      window.onload = loadProfile;
    </script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
